name: Convert All Rules to MRS

# è§¦å‘æœºåˆ¶ï¼š
# 1. ä»»æ„ .list æ–‡ä»¶å‘ç”Ÿ push æ—¶è§¦å‘
# 2. æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è§¦å‘ (workflow_dispatch)
on:
  push:
    paths:
      - '**/*.list'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æƒé™ï¼šå…è®¸æäº¤ç”Ÿæˆçš„æ–‡ä»¶

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Kernel
        run: |
          # 1. è·å– Mihomo Alpha æœ€æ–°ç‰ˆä¸‹è½½é“¾æ¥ (Alphaç‰ˆé€šå¸¸åŒ…å«æœ€æ–°çš„è½¬æ¢é€»è¾‘)
          echo "Fetching latest Mihomo Alpha URL..."
          LATEST_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/Prerelease-Alpha | grep "browser_download_url" | grep "linux-amd64-alpha" | grep ".gz" | head -n 1 | cut -d '"' -f 4)
          
          # 2. ä¸‹è½½å¹¶è§£å‹
          echo "Downloading from $LATEST_URL"
          wget -q "$LATEST_URL" -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          
          # 3. éªŒè¯ç‰ˆæœ¬
          ./mihomo -v

      - name: Recursively Convert Files
        run: |
          # find å‘½ä»¤è§£é‡Šï¼š
          # .             : ä»å½“å‰æ ¹ç›®å½•å¼€å§‹
          # -type f       : åªæŸ¥æ‰¾æ–‡ä»¶
          # -name "*.list": æ–‡ä»¶ååŒ¹é… .list
          # -not -path    : æ’é™¤ .git æ–‡ä»¶å¤¹
          
          find . -type f -name "*.list" -not -path "*/.git/*" | while read -r file; do
            echo "----------------------------------------"
            echo "ğŸ” å‘ç°è§„åˆ™æ–‡ä»¶: $file"
            
            # è®¡ç®—è¾“å‡ºæ–‡ä»¶åï¼šæŠŠ .list æ¢æˆ .mrs
            output_file="${file%.list}.mrs"
            
            # æ‰§è¡Œè½¬æ¢
            # ä½¿ç”¨ 'classical' æ¨¡å¼ï¼Œå®ƒèƒ½å®Œç¾å¤„ç†ä½ æä¾›çš„å¸¦æœ‰ DOMAIN-SUFFIX/IP-CIDR å‰ç¼€çš„æ··åˆå†…å®¹
            if ./mihomo convert-ruleset classical "$file" "$output_file"; then
              echo "âœ… è½¬æ¢æˆåŠŸ -> $output_file"
            else
              echo "âŒ è½¬æ¢å¤±è´¥: $file"
              # å¤±è´¥ä¸é˜»æ–­æµç¨‹ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
            fi
          done

      - name: Commit and Push MRS files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-convert: Update MRS rule files [skip ci]"
          # è¿™é‡Œçš„ **/*.mrs ä¼šåŒ¹é…æ‰€æœ‰ç›®å½•ä¸‹çš„ mrs æ–‡ä»¶
          file_pattern: '**/*.mrs'
