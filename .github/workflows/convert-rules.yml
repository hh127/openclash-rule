name: Auto Convert List to MRS

on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Core
        run: |
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-amd64-v1.18.1.gz -O mihomo.gz
          gunzip mihomo.gz
          chmod +x mihomo

      - name: Convert Files (Safe Mode)
        run: |
          echo "ğŸ” æ­£åœ¨æœç´¢ list æ–‡ä»¶..."
          
          # æŸ¥æ‰¾æ‰€æœ‰ list æ–‡ä»¶
          find . -type f -name "*.list" | while read -r file; do
            echo "----------------------------------------"
            echo "ğŸ“„ å¤„ç†æ–‡ä»¶: $file"
            
            # è®¡ç®—ç›®æ ‡æ–‡ä»¶å (ä¾‹å¦‚ ./mihomoè§„åˆ™/ad.list -> ./mihomoè§„åˆ™/ad.mrs)
            output="${file%.*}.mrs"
            
            # ã€å…³é”®æ­¥éª¤ã€‘
            # ä¸ºäº†é˜²æ­¢ä¸­æ–‡è·¯å¾„å¯¼è‡´å‘½ä»¤å¤±æ•ˆï¼Œå…ˆå¤åˆ¶åˆ°æ ¹ç›®å½•å˜æˆçº¯è‹±æ–‡æ–‡ä»¶å
            cp "$file" temp_input.list
            
            echo "âš¡ æ­£åœ¨è½¬æ¢ (ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶è§„é¿è·¯å¾„é—®é¢˜)..."
            
            # è¿™é‡Œçš„å‘½ä»¤åªæ“ä½œ temp_input.listï¼Œç»å¯¹ä¸ä¼šå‡ºé”™
            # æ³¨æ„ï¼šå¦‚æœä½ çš„è§„åˆ™å…¨æ˜¯IPï¼Œè¯·æŠŠ domain æ”¹ä¸º ipcidr
            ./mihomo convert-ruleset domain temp_input.list temp_output.mrs
            
            # æ£€æŸ¥æ˜¯å¦ç”ŸæˆæˆåŠŸ
            if [ -f "temp_output.mrs" ]; then
                # æŠŠç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
                mv temp_output.mrs "$output"
                echo "âœ… æˆåŠŸç”Ÿæˆ: $output"
            else
                echo "âŒ è½¬æ¢å¤±è´¥ï¼Œæœªç”Ÿæˆæ–‡ä»¶"
                # å¦‚æœå¤±è´¥ï¼Œæ‰“å°ä¸€ä¸‹é”™è¯¯æ—¥å¿—æ–¹ä¾¿è°ƒè¯•ï¼Œä½†ä¸è¦å¡æ­»æµç¨‹
                exit 1 
            fi
            
            # æ¸…ç†ä¸´æ—¶è¾“å…¥æ–‡ä»¶
            rm temp_input.list
          done

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update mrs files [skip ci]"
          file_pattern: '**.mrs'
