name: Convert All Rules to MRS

on:
  push:
    paths:
      - '**/*.list'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Kernel
        run: |
          echo "Fetching latest Mihomo Alpha URL..."
          LATEST_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/Prerelease-Alpha | grep "browser_download_url" | grep "linux-amd64-alpha" | grep ".gz" | head -n 1 | cut -d '"' -f 4)
          
          echo "Downloading from $LATEST_URL"
          wget -q "$LATEST_URL" -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: Recursively Convert Files
        run: |
          find . -type f -name "*.list" -not -path "*/.git/*" | while read -r file; do
            echo "----------------------------------------"
            echo "üîç ÂèëÁé∞ËßÑÂàôÊñá‰ª∂: $file"
            
            output_file="${file%.list}.mrs"
            
            # ‰øÆÂ§çÁÇπÔºöÊ∑ªÂä†‰∫Ü 'mrs' ÂèÇÊï∞
            # ËØ≠Ê≥ï: ./mihomo convert-ruleset <behavior> <format> <source> <target>
            if ./mihomo convert-ruleset classical mrs "$file" "$output_file"; then
              echo "‚úÖ ËΩ¨Êç¢ÊàêÂäü -> $output_file"
            else
              echo "‚ùå ËΩ¨Êç¢Â§±Ë¥•: $file"
            fi
          done

      - name: Commit and Push MRS files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-convert: Update MRS rule files [skip ci]"
          file_pattern: '**/*.mrs'
