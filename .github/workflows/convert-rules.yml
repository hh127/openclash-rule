name: Auto Convert List to MRS (Final)

on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Download Mihomo Core
        # å…ˆç”¨ Shell ä¸‹è½½å†…æ ¸ï¼Œæ¯”è¾ƒæ–¹ä¾¿
        run: |
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ Mihomo..."
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.18.3/mihomo-linux-amd64-v1.18.3.gz -O mihomo.gz
          gunzip mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: Run Conversion Script
        # ã€é‡ç‚¹ã€‘è¿™é‡Œç›´æ¥æŒ‡å®š shell: pythonï¼Œä¸éœ€è¦ cat ç”Ÿæˆæ–‡ä»¶äº†
        shell: python
        run: |
          import os
          import subprocess
          import shutil

          print("ğŸš€ Python è„šæœ¬å¼€å§‹è¿è¡Œ...")

          # 1. æ‰«ææ‰€æœ‰ .list æ–‡ä»¶
          list_files = []
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file.endswith(".list"):
                      # æ’é™¤æ‰ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶ï¼Œé˜²æ­¢æ­»å¾ªç¯
                      if "temp_" not in file:
                          list_files.append(os.path.join(root, file))

          print(f"ğŸ” ä¸€å…±æ‰¾åˆ° {len(list_files)} ä¸ª list æ–‡ä»¶")

          if len(list_files) == 0:
              print("âš ï¸ æœªæ‰¾åˆ°ä»»ä½•æ–‡ä»¶ï¼Œè„šæœ¬ç»“æŸ")
              exit(0)

          # 2. å¾ªç¯è½¬æ¢
          success_count = 0
          for file_path in list_files:
              print("-" * 40)
              print(f"ğŸ“„ æ­£åœ¨å¤„ç†: {file_path}")

              # å‡†å¤‡ä¸´æ—¶æ–‡ä»¶å (é¿å…ä¸­æ–‡è·¯å¾„é—®é¢˜)
              temp_input = "temp_input.list"
              temp_output = "temp_output.mrs"
              
              # å¤åˆ¶æºæ–‡ä»¶ -> ä¸´æ—¶æ–‡ä»¶
              shutil.copy(file_path, temp_input)

              # === æ™ºèƒ½åˆ¤æ–­ç±»å‹ (å¯é€‰) ===
              # ç®€å•çš„é€»è¾‘ï¼šå¦‚æœæ–‡ä»¶ååŒ…å« "ip"ï¼Œå°±ç”¨ ipcidrï¼Œå¦åˆ™ç”¨ domain
              # ä½ ä¹Ÿå¯ä»¥å…¨éƒ¨å¼ºåˆ¶ç”¨ domain
              rule_type = "domain"
              if "ip" in os.path.basename(file_path).lower():
                  rule_type = "ipcidr"
                  print(f"   âš™ï¸ æ£€æµ‹åˆ°æ–‡ä»¶ååŒ…å« ipï¼Œæ¨¡å¼è®¾å®šä¸º: {rule_type}")
              else:
                  print(f"   âš™ï¸ é»˜è®¤æ¨¡å¼: {rule_type}")

              # æ„é€ å‘½ä»¤
              cmd = ["./mihomo", "convert-ruleset", rule_type, temp_input, temp_output]

              # æ‰§è¡Œå‘½ä»¤ (input=b'' ç”¨äºé˜²æ­¢ mihomo è¯»å– stdin å¡æ­»)
              try:
                  result = subprocess.run(cmd, capture_output=True, input=b'')
                  
                  if result.returncode == 0 and os.path.exists(temp_output):
                      # è®¡ç®—æœ€ç»ˆ mrs æ–‡ä»¶è·¯å¾„
                      target_mrs = os.path.splitext(file_path)[0] + ".mrs"
                      shutil.move(temp_output, target_mrs)
                      print(f"âœ… è½¬æ¢æˆåŠŸ! ç”Ÿæˆæ–‡ä»¶: {target_mrs}")
                      success_count += 1
                  else:
                      print(f"âŒ è½¬æ¢å¤±è´¥!")
                      print(f"   STDERR: {result.stderr.decode().strip()}")
                      print(f"   STDOUT: {result.stdout.decode().strip()}")

              except Exception as e:
                  print(f"âŒ è¿è¡Œå¼‚å¸¸: {str(e)}")

              # æ¸…ç†å½“å‰å¾ªç¯çš„ä¸´æ—¶æ–‡ä»¶
              if os.path.exists(temp_input): os.remove(temp_input)
              if os.path.exists(temp_output): os.remove(temp_output)

          print("=" * 40)
          print(f"ğŸ‰ ä»»åŠ¡æ€»ç»“: æˆåŠŸè½¬æ¢ {success_count} / {len(list_files)} ä¸ªæ–‡ä»¶")

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto convert list to mrs [skip ci]"
          file_pattern: '**.mrs'
