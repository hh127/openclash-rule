name: Auto Convert List to MRS

on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Core
        run: |
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-amd64-v1.18.1.gz -O mihomo.gz
          gunzip mihomo.gz
          chmod +x mihomo

      - name: Convert Files (Recursive)
        run: |
          echo "ğŸ” æ­£åœ¨å…¨ä»“åº“æœç´¢ .list æ–‡ä»¶..."
          
          # ä½¿ç”¨ find å‘½ä»¤æŸ¥æ‰¾å½“å‰ç›®å½•åŠå­ç›®å½•ä¸‹æ‰€æœ‰çš„ .list æ–‡ä»¶
          find . -type f -name "*.list" | while read -r file; do
            echo "----------------------------------------"
            echo "ğŸ“„ å‘ç°æ–‡ä»¶: $file"
            
            # ç”Ÿæˆå¯¹åº”çš„ mrs æ–‡ä»¶å (ä¿æŒåŸæœ‰è·¯å¾„)
            # ä¾‹å¦‚ ./rules/ad.list -> ./rules/ad.mrs
            output="${file%.*}.mrs"
            
            echo "âš¡ æ­£åœ¨è½¬æ¢: $file -> $output"
            
            # åŒæ ·ï¼Œå¦‚æœæ˜¯IPåˆ—è¡¨ï¼Œè¯·æŠŠ domain æ”¹ä¸º ipcidr
            ./mihomo convert-ruleset domain "$file" "$output"
            
            if [ -f "$output" ]; then
                echo "âœ… ç”ŸæˆæˆåŠŸ: $output"
            else
                echo "âŒ ç”Ÿæˆå¤±è´¥!"
            fi
          done

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update mrs files [skip ci]"
          file_pattern: '**.mrs' # æäº¤æ‰€æœ‰ç›®å½•ä¸‹çš„ mrs æ–‡ä»¶
