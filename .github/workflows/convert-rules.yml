name: Auto Convert List to MRS

# è§¦å‘æœºåˆ¶ï¼šå½“ list æ–‡ä»¶å˜åŠ¨ï¼Œæˆ–æ‰‹åŠ¨ç‚¹å‡»è§¦å‘
on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    # å¿…é¡»èµ‹äºˆå†™æƒé™ï¼Œå¦åˆ™æ— æ³•ä¸Šä¼ ç”Ÿæˆçš„ mrs æ–‡ä»¶
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Core
        run: |
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ Mihomo å†…æ ¸..."
          # ä¸‹è½½ v1.18.1 ç‰ˆæœ¬ (å’Œä½ æ—¥å¿—é‡Œçš„ä¸€è‡´)
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-amd64-v1.18.1.gz -O mihomo.gz
          
          echo "âš™ï¸ è§£å‹å¹¶èµ‹äºˆæ‰§è¡Œæƒé™..."
          gunzip mihomo.gz
          chmod +x mihomo
          
          # éªŒè¯ç‰ˆæœ¬ï¼Œç¡®ä¿ä¸‹è½½æˆåŠŸ
          ./mihomo -v

      - name: Convert Files
        run: |
          echo "ğŸ”„ å¼€å§‹è½¬æ¢..."
          
          # æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„ .list æ–‡ä»¶
          for file in *.list; do
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ° list æ–‡ä»¶ï¼Œè·³è¿‡
            [ -e "$file" ] || continue
            
            # è·å–ä¸å¸¦åç¼€çš„æ–‡ä»¶å (ä¾‹å¦‚ ad.list -> ad)
            filename="${file%.*}"
            
            echo "æ­£åœ¨å¤„ç†: $file -> $filename.mrs"
            
            # ã€å…³é”®ã€‘è¿™é‡Œæ˜¯å•è¡Œå‘½ä»¤ï¼Œç»å¯¹ä¸è¦æ¢è¡Œ
            # é»˜è®¤ä½¿ç”¨ 'domain' ç±»å‹ã€‚å¦‚æœä½ çš„æ˜¯ IP åˆ—è¡¨ï¼Œè¯·æŠŠä¸‹é¢çš„ domain æ”¹ä¸º ipcidr
            ./mihomo convert-ruleset domain "$file" "$filename.mrs"
          done
          
          echo "âœ… æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæ¯•ã€‚"

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto convert list to mrs [skip ci]"
          file_pattern: '*.mrs'
