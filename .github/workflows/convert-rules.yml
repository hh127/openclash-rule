name: Convert All Rules to MRS

on:
  push:
    paths:
      - '**/*.list'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Kernel
        run: |
          echo "Fetching latest Mihomo Alpha URL..."
          LATEST_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/Prerelease-Alpha | grep "browser_download_url" | grep "linux-amd64-alpha" | grep ".gz" | head -n 1 | cut -d '"' -f 4)
          
          echo "Downloading from $LATEST_URL"
          wget -q "$LATEST_URL" -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: Recursively Convert Files
        run: |
          find . -type f -name "*.list" -not -path "*/.git/*" | while read -r file; do
            echo "----------------------------------------"
            echo "ğŸ” å‘ç°è§„åˆ™æ–‡ä»¶: $file"
            
            output_file="${file%.list}.mrs"
            
            # å…³é”®ä¿®æ”¹ï¼š
            # å‚æ•° 2 ä» 'mrs' æ”¹ä¸º 'text'
            # å«ä¹‰ï¼šä½¿ç”¨ classical è¡Œä¸ºï¼Œè¯»å– text æ ¼å¼çš„æºæ–‡ä»¶ï¼Œè¾“å‡ºåˆ° output_file
            if ./mihomo convert-ruleset classical text "$file" "$output_file"; then
              echo "âœ… è½¬æ¢æˆåŠŸ -> $output_file"
            else
              echo "âŒ è½¬æ¢å¤±è´¥: $file"
              # æ‰“å°æ–‡ä»¶å¤´å‡ è¡Œå¸®åŠ© debugï¼ˆå¦‚æœå¤±è´¥çš„è¯ï¼‰
              head -n 5 "$file"
            fi
          done

      - name: Commit and Push MRS files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-convert: Update MRS rule files [skip ci]"
          file_pattern: '**/*.mrs'
