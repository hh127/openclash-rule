name: Auto Convert List to MRS (Docker)

on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Convert using Docker
        run: |
          echo "ğŸ³ å‡†å¤‡ä½¿ç”¨ Docker ç¯å¢ƒ..."
          
          # æ‹‰å–å®˜æ–¹æœ€æ–°é•œåƒ (ä½¿ç”¨ alpine ç‰ˆä½“ç§¯å°)
          docker pull metacubex/mihomo:alpha
          
          echo "ğŸ” æ­£åœ¨æœç´¢å¹¶è½¬æ¢..."
          
          # æŸ¥æ‰¾æ‰€æœ‰ list æ–‡ä»¶
          # ä½¿ç”¨ process substitution é¿å…ç®¡é“åæ‰ stdin
          while IFS= read -r file; do
            echo "----------------------------------------"
            echo "ğŸ“„ å¤„ç†æ–‡ä»¶: $file"
            
            # 1. ä¸ºäº†é¿å¼€ä¸­æ–‡è·¯å¾„åœ°é›·ï¼Œå¤åˆ¶åˆ°æ ¹ç›®å½•ä¸´æ—¶æ–‡ä»¶
            cp "$file" input_temp.list
            
            # 2. è¿è¡Œ Docker è¿›è¡Œè½¬æ¢
            # --rm: è·‘å®Œå³åˆ å®¹å™¨
            # -v $(pwd):/data: æŠŠå½“å‰ä»“åº“æŒ‚è½½åˆ°å®¹å™¨çš„ /data ç›®å½•
            # è¿™é‡Œçš„å‘½ä»¤ç»å¯¹çº¯å‡€ï¼Œä¸ä¼šå—å¤–éƒ¨ç¯å¢ƒå¹²æ‰°
            docker run --rm -v "$(pwd):/data" metacubex/mihomo:alpha \
              convert-ruleset domain /data/input_temp.list /data/output_temp.mrs
            
            # 3. æ£€æŸ¥å¹¶ç§»å›æ–‡ä»¶
            if [ -f "output_temp.mrs" ]; then
                target_mrs="${file%.*}.mrs"
                mv output_temp.mrs "$target_mrs"
                echo "âœ… è½¬æ¢æˆåŠŸ: $target_mrs"
            else
                echo "âŒ è½¬æ¢å¤±è´¥!"
                exit 1
            fi
            
            # æ¸…ç†è¾“å…¥ä¸´æ—¶æ–‡ä»¶
            rm input_temp.list
            
          done < <(find . -type f -name "*.list")

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: convert list to mrs via docker [skip ci]"
          file_pattern: '**.mrs'
