name: Convert All Rules to MRS

on:
  push:
    paths:
      - '**/*.list'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Kernel
        run: |
          echo "Fetching latest Mihomo Alpha..."
          # è·å–æœ€æ–°çš„ Alpha ç‰ˆæœ¬é“¾æ¥
          LATEST_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/Prerelease-Alpha | grep "browser_download_url" | grep "linux-amd64-alpha" | grep ".gz" | head -n 1 | cut -d '"' -f 4)
          
          echo "Downloading from $LATEST_URL"
          wget -q "$LATEST_URL" -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: Recursively Convert Files
        run: |
          # éå†æ‰€æœ‰ .list æ–‡ä»¶
          find . -type f -name "*.list" -not -path "*/.git/*" | while read -r file; do
            echo "----------------------------------------"
            echo "ğŸ” å¤„ç†æ–‡ä»¶: $file"
            
            output_file="${file%.list}.mrs"
            temp_file="temp_clean.list"

            # === å¼ºåŠ›æ¸…æ´—ç®¡é“ (Cleaning Pipeline) ===
            # 1. cat "$file"      : è¯»å–æºæ–‡ä»¶
            # 2. tr -d '\r'       : ã€å…³é”®ã€‘å»é™¤ Windows å›è½¦ç¬¦ (CRLF -> LF)
            # 3. sed 's/#.*//g'   : ã€å…³é”®ã€‘å»é™¤æ‰€æœ‰ `#` åŠå…¶åé¢çš„å†…å®¹ï¼ˆåŒ…æ‹¬ä¸­æ–‡å¤‡æ³¨ã€è¡Œå†…æ³¨é‡Šï¼‰
            # 4. awk ...          : ã€å…³é”®ã€‘åªæå–å‰ä¸¤åˆ— (Type,Value)ï¼Œä¸¢å¼ƒ ,DIRECT, ,no-resolve ç­‰åç¼€
            # 5. grep ...         : å»é™¤ç©ºè¡Œ
            
            cat "$file" | tr -d '\r' | sed 's/#.*//g' | awk -F, '{
              # å»é™¤ $1 å’Œ $2 çš„å‰åç©ºæ ¼
              gsub(/^[ \t]+|[ \t]+$/, "", $1); 
              gsub(/^[ \t]+|[ \t]+$/, "", $2); 
              
              # åªæœ‰å½“ Type å’Œ Value éƒ½æœ‰å€¼æ—¶æ‰è¾“å‡º
              # è¿™æ ·å¯ä»¥è‡ªåŠ¨è¿‡æ»¤æ‰ç©ºè¡Œæˆ–æ ¼å¼é”™è¯¯çš„è¡Œ
              if ($1 != "" && $2 != "") {
                print $1","$2
              }
            }' > "$temp_file"

            # æ£€æŸ¥æ¸…æ´—åçš„æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if [ ! -s "$temp_file" ]; then
              echo "âš ï¸  è·³è¿‡: æ–‡ä»¶æ¸…æ´—åä¸ºç©º (å¯èƒ½æ˜¯çº¯æ³¨é‡Šæ–‡ä»¶) -> $file"
              rm "$temp_file"
              continue
            fi

            # æ‰§è¡Œè½¬æ¢
            # è¯­æ³•: ./mihomo convert-ruleset classical text <æºæ–‡ä»¶> <è¾“å‡ºæ–‡ä»¶>
            if ./mihomo convert-ruleset classical text "$temp_file" "$output_file"; then
              echo "âœ… è½¬æ¢æˆåŠŸ -> $output_file"
            else
              echo "âŒ è½¬æ¢å¤±è´¥: $file"
              echo "--- è°ƒè¯•ï¼šæ¸…æ´—åçš„æ–‡ä»¶å†…å®¹ (å‰10è¡Œ) ---"
              head -n 10 "$temp_file"
            fi
            
            # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            rm "$temp_file"
          done

      - name: Commit and Push MRS files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-convert: Update MRS rule files [skip ci]"
          file_pattern: '**/*.mrs'
