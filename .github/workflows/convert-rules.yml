name: Convert All Rules to MRS

on:
  push:
    paths:
      - '**/*.list'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mihomo Kernel (Stable)
        run: |
          echo "Fetching latest Stable Mihomo..."
          # ã€ä¿®å¤ç‚¹1ã€‘ä½¿ç”¨ releases/latest è·å–æœ€æ–°çš„ç¨³å®šç‰ˆï¼Œè€Œä¸æ˜¯ Alpha ç‰ˆ
          # ç¨³å®šç‰ˆé€šå¸¸æ›´å¯é ï¼Œä¸ä¼šå‡ºç°è«åçš„ç©ºæŒ‡é’ˆå´©æºƒ
          LATEST_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep "browser_download_url" | grep "linux-amd64-v" | grep ".gz" | head -n 1 | cut -d '"' -f 4)
          
          if [ -z "$LATEST_URL" ]; then
            echo "âŒ è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å›ºå®šç‰ˆæœ¬ v1.19.3"
            LATEST_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz"
          fi

          echo "Downloading from $LATEST_URL"
          wget -q "$LATEST_URL" -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: Recursively Convert Files
        run: |
          find . -type f -name "*.list" -not -path "*/.git/*" | while read -r file; do
            echo "----------------------------------------"
            echo "ğŸ” å¤„ç†æ–‡ä»¶: $file"
            
            output_file="${file%.list}.mrs"
            temp_file="temp_clean.list"

            # === ç™½åå•æ¸…æ´—ç®¡é“ ===
            # 1. tr -d '\r': å»é™¤ Windows æ¢è¡Œ
            # 2. sed 's/#.*//g': å»é™¤æ³¨é‡Š
            # 3. awk ...: åªä¿ç•™å‰ä¸¤åˆ—
            # 4. grep -E ...: ã€ä¿®å¤ç‚¹2ã€‘åªå…è®¸ DOMAIN å’Œ IP å¼€å¤´çš„è§„åˆ™é€šè¿‡
            #    (è¿‡æ»¤æ‰ PROCESS-NAMEï¼Œå› ä¸ºå®ƒä¸æ”¯æŒ MRS æ ¼å¼ï¼Œä¼šå¯¼è‡´è½¬æ¢å™¨æŠ¥é”™)
            
            cat "$file" | tr -d '\r' | sed 's/#.*//g' | awk -F, '{
              gsub(/^[ \t]+|[ \t]+$/, "", $1); 
              gsub(/^[ \t]+|[ \t]+$/, "", $2); 
              if ($1 != "" && $2 != "") {
                print $1","$2
              }
            }' | grep -E "^(DOMAIN|IP-CIDR|SRC-IP-CIDR|GEOIP|GEOSITE|CLASSICAL)" > "$temp_file"

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if [ ! -s "$temp_file" ]; then
              echo "âš ï¸  è·³è¿‡: æœ‰æ•ˆè§„åˆ™ä¸ºç©º -> $file"
              rm "$temp_file"
              continue
            fi

            # æ‰§è¡Œè½¬æ¢
            # å¦‚æœæ˜¯ç¨³å®šç‰ˆï¼Œè¯­æ³•å¯èƒ½ä¸éœ€è¦ 'text' å‚æ•°ï¼Œæˆ–è€…ä»ç„¶å…¼å®¹ã€‚
            # æˆ‘ä»¬å…ˆå°è¯•å¸¦ 'text' å‚æ•° (v1.18+ æ ‡å‡†)
            if ./mihomo convert-ruleset classical text "$temp_file" "$output_file"; then
              echo "âœ… è½¬æ¢æˆåŠŸ -> $output_file"
            else
              echo "âš ï¸ ç¬¬ä¸€æ¬¡å°è¯•å¤±è´¥ï¼Œå°è¯•ä¸å¸¦ 'text' å‚æ•° (å…¼å®¹æ—§ç‰ˆæœ¬è¯­æ³•)..."
              if ./mihomo convert-ruleset classical "$temp_file" "$output_file"; then
                 echo "âœ… è½¬æ¢æˆåŠŸ (å…¼å®¹æ¨¡å¼) -> $output_file"
              else
                 echo "âŒ è½¬æ¢å¤±è´¥: $file"
                 echo "--- è°ƒè¯•å†…å®¹ ---"
                 head -n 5 "$temp_file"
              fi
            fi
            
            rm "$temp_file"
          done

      - name: Commit and Push MRS files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-convert: Update MRS rule files (Stable Build) [skip ci]"
          file_pattern: '**/*.mrs'
