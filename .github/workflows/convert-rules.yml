name: Convert Rulesets to MRS

on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Mihomo
        run: |
          # 获取最新的 mihomo 核心
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep "browser_download_url.*linux-amd64-compatible" | cut -d '"' -f 4 | head -n 1)
          curl -L -o mihomo.gz "$MIHOMO_URL"
          gunzip -c mihomo.gz > mihomo
          chmod +x mihomo

      - name: Convert Lists to MRS
        run: |
          mkdir -p mrs
          # 遍历仓库中所有的 .list 文件
          find . -name "*.list" | while read file; do
            filename=$(basename "$file" .list)
            filepath=$(dirname "$file")
            
            # 逻辑判断：根据文件名判断转换类型
            if [[ "$filename" == *"domains"* ]]; then
              TYPE="domain"
            elif [[ "$filename" == *"ip"* ]]; then
              TYPE="ipcidr"
            else
              # 默认兜底使用 domain，或者跳过
              TYPE="domain" 
            fi
            
            echo "Converting $file as $TYPE..."
            ./mihomo convert-ruleset "$TYPE" text "$file" "./mrs/${filename}.mrs"
          done

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ./mrs/*.mrs
          git commit -m "Auto-convert to MRS: ${GITHUB_SHA::7}" || echo "No changes to commit"
          git push