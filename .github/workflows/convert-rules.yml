name: Auto Convert List to MRS (Docker Fixed)

on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Convert using Docker
        run: |
          echo "ğŸ³ å‡†å¤‡æ‹‰å–å®˜æ–¹é•œåƒ..."
          
          # ä½¿ç”¨ GitHub Container Registry (å®˜æ–¹æº)ï¼Œç¡®ä¿æ ‡ç­¾å­˜åœ¨
          docker pull ghcr.io/metacubex/mihomo:latest
          
          echo "ğŸ” æ­£åœ¨æœç´¢å¹¶è½¬æ¢..."
          
          # æŸ¥æ‰¾æ‰€æœ‰ list æ–‡ä»¶
          # ä½¿ç”¨ process substitution é¿å…ç®¡é“é—®é¢˜
          while IFS= read -r file; do
            echo "----------------------------------------"
            echo "ğŸ“„ å¤„ç†æ–‡ä»¶: $file"
            
            # 1. å¤åˆ¶ä¸ºä¸´æ—¶æ–‡ä»¶ (è§„é¿ä¸­æ–‡è·¯å¾„)
            cp "$file" input_temp.list
            
            # 2. è¿è¡Œ Docker è¿›è¡Œè½¬æ¢
            # -v $(pwd):/data  æŒ‚è½½å½“å‰ç›®å½•
            # < /dev/null      å…³é”®ï¼é˜²æ­¢ mihomo å·åƒ stdin å¯¼è‡´å¡æ­»
            
            docker run --rm -i -v "$(pwd):/data" ghcr.io/metacubex/mihomo:latest \
              convert-ruleset domain /data/input_temp.list /data/output_temp.mrs < /dev/null
            
            # 3. æ£€æŸ¥å¹¶ç§»å›æ–‡ä»¶
            if [ -f "output_temp.mrs" ]; then
                target_mrs="${file%.*}.mrs"
                mv output_temp.mrs "$target_mrs"
                echo "âœ… è½¬æ¢æˆåŠŸ: $target_mrs"
            else
                echo "âŒ è½¬æ¢å¤±è´¥!"
                # æ‰“å°ä¸€ä¸‹æ–‡ä»¶åˆ—è¡¨çœ‹çœ‹æœ‰æ²¡æœ‰ç”Ÿæˆå¥‡æ€ªçš„ä¸œè¥¿
                ls -lh
                exit 1
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm input_temp.list
            
          done < <(find . -type f -name "*.list")

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update mrs files [skip ci]"
          file_pattern: '**.mrs'
