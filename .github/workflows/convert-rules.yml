name: Auto Convert List to MRS (Python)

on:
  push:
    paths:
      - '**.list'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Convert Rules
        run: |
          # åˆ›å»ºå¹¶è¿è¡Œ Python è„šæœ¬
          cat << 'EOF' > convert.py
          import os
          import subprocess
          import shutil
          import glob

          # 1. ä¸‹è½½å¹¶è§£å‹ Mihomo
          print("â¬‡ï¸  æ­£åœ¨ä¸‹è½½ Mihomo å†…æ ¸...")
          subprocess.run("wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.18.3/mihomo-linux-amd64-v1.18.3.gz -O mihomo.gz", shell=True)
          subprocess.run("gunzip mihomo.gz", shell=True)
          subprocess.run("chmod +x mihomo", shell=True)

          if not os.path.exists("./mihomo"):
              print("âŒ Mihomo ä¸‹è½½å¤±è´¥")
              exit(1)

          print("âœ… Mihomo å‡†å¤‡å°±ç»ª")

          # 2. æŸ¥æ‰¾æ‰€æœ‰ .list æ–‡ä»¶ (é€’å½’)
          list_files = []
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file.endswith(".list"):
                      list_files.append(os.path.join(root, file))

          print(f"ğŸ” æ‰¾åˆ° {len(list_files)} ä¸ª list æ–‡ä»¶")

          # 3. å¼€å§‹è½¬æ¢
          for file_path in list_files:
              print("-" * 30)
              print(f"ğŸ“„ å¤„ç†æ–‡ä»¶: {file_path}")
              
              # æ„é€ ä¸´æ—¶æ–‡ä»¶å (çº¯è‹±æ–‡ï¼Œé¿å…è·¯å¾„ä¹±ç )
              temp_input = "temp_input.list"
              temp_output = "temp_output.mrs"
              
              # å¤åˆ¶æºæ–‡ä»¶åˆ°ä¸´æ—¶æ–‡ä»¶
              shutil.copy(file_path, temp_input)
              
              # æ‰§è¡Œè½¬æ¢å‘½ä»¤
              # æ³¨æ„ï¼šinput=b'' æ˜¯ä¸ºäº†åˆ‡æ–­ stdinï¼Œé˜²æ­¢å¡æ­»
              # å¦‚æœä½ çš„è§„åˆ™å…¨æ˜¯ IPï¼Œè¯·æŠŠ 'domain' æ”¹ä¸º 'ipcidr'
              cmd = ["./mihomo", "convert-ruleset", "domain", temp_input, temp_output]
              
              result = subprocess.run(cmd, capture_output=True, input=b'')
              
              if result.returncode == 0 and os.path.exists(temp_output):
                  # è®¡ç®—ç›®æ ‡è·¯å¾„
                  target_mrs = os.path.splitext(file_path)[0] + ".mrs"
                  shutil.move(temp_output, target_mrs)
                  print(f"âœ… è½¬æ¢æˆåŠŸ -> {target_mrs}")
              else:
                  print(f"âŒ è½¬æ¢å¤±è´¥: {file_path}")
                  print(f"é”™è¯¯ä¿¡æ¯: {result.stderr.decode()}")

              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              if os.path.exists(temp_input):
                  os.remove(temp_input)

          print("-" * 30)
          print("ğŸ‰ æ‰€æœ‰ä»»åŠ¡å®Œæˆ")
          EOF
          
          # æ‰§è¡Œä¸Šé¢çš„è„šæœ¬
          python convert.py

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update mrs files via python [skip ci]"
          file_pattern: '**.mrs'
